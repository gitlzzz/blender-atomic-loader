default_colour = (0.0129016, 0.0129016, 0.0129016, 1)
default_diameter = 0.25

default_properties = {
    "C": {"diameter": 0.22, "colour": "Red"}, 
    "N": {"diameter": 0.24, "colour": "Blue"}, 
    "H": {"diameter": 0.11, "colour": "White"}
}


default_properties = {
    "H": {"diameter": [1.0, 1.0, 1.0, 1.0], "size": 0.08928571428571429}, 
    "He": {"diameter": [0.8509803921568627, 1.0, 1.0, 1.0], "size": 0.11071428571428572}, 
    "Li": {"diameter": [0.8, 0.5019607843137255, 1.0, 1.0], "size": 0.5178571428571429}, 
    "Be": {"diameter": [0.7607843137254902, 1.0, 0.0, 1.0], "size": 0.37500000000000006}, 
    "B": {"diameter": [1.0, 0.7098039215686275, 0.7098039215686275, 1.0], "size": 0.3035714285714286}, 
    "C": {"diameter": [0.5647058823529412, 0.5647058823529412, 0.5647058823529412, 1.0], "size": 0.25}, 
    "N": {"diameter": [0.18823529411764706, 0.3137254901960784, 0.9725490196078431, 1.0], "size": 0.23214285714285718}, 
    "O": {"diameter": [1.0, 0.050980392156862744, 0.050980392156862744, 1.0], "size": 0.2142857142857143}, 
    "F": {"diameter": [0.5647058823529412, 0.8784313725490196, 0.3137254901960784, 1.0], "size": 0.17857142857142858}, 
    "Ne": {"diameter": [0.7019607843137254, 0.8901960784313725, 0.9607843137254902, 1.0], "size": 0.13571428571428573}, 
    "Na": {"diameter": [0.6705882352941176, 0.3607843137254902, 0.9490196078431372, 1.0], "size": 0.6428571428571429}, 
    "Mg": {"diameter": [0.5411764705882353, 1.0, 0.0, 1.0], "size": 0.5357142857142857}, 
    "Al": {"diameter": [0.7490196078431373, 0.6509803921568628, 0.6509803921568628, 1.0], "size": 0.44642857142857145}, 
    "Si": {"diameter": [0.9411764705882353, 0.7843137254901961, 0.6274509803921569, 1.0], "size": 0.3928571428571429}, 
    "P": {"diameter": [1.0, 0.5019607843137255, 0.0, 1.0], "size": 0.35714285714285715}, 
    "S": {"diameter": [1.0, 1.0, 0.18823529411764706, 1.0], "size": 0.35714285714285715}, 
    "Cl": {"diameter": [0.12156862745098039, 0.9411764705882353, 0.12156862745098039, 1.0], "size": 0.35714285714285715}, 
    "Ar": {"diameter": [0.5019607843137255, 0.8196078431372549, 0.8901960784313725, 1.0], "size": 0.25357142857142856}, 
    "K": {"diameter": [0.5607843137254902, 0.25098039215686274, 0.8313725490196079, 1.0], "size": 0.7857142857142858}, 
    "Ca": {"diameter": [0.23921568627450981, 1.0, 0.0, 1.0], "size": 0.6428571428571429}, 
    "Sc": {"diameter": [0.9019607843137255, 0.9019607843137255, 0.9019607843137255, 1.0], "size": 0.5714285714285715}, 
    "Ti": {"diameter": [0.7490196078431373, 0.7607843137254902, 0.7803921568627451, 1.0], "size": 0.5}, 
    "V": {"diameter": [0.6509803921568628, 0.6509803921568628, 0.6705882352941176, 1.0], "size": 0.4821428571428572}, 
    "Cr": {"diameter": [0.5411764705882353, 0.6, 0.7803921568627451, 1.0], "size": 0.5}, 
    "Mn": {"diameter": [0.611764705882353, 0.47843137254901963, 0.7803921568627451, 1.0], "size": 0.5}, 
    "Fe": {"diameter": [0.8784313725490196, 0.4, 0.2, 1.0], "size": 0.5}, 
    "Co": {"diameter": [0.9411764705882353, 0.5647058823529412, 0.6274509803921569, 1.0], "size": 0.4821428571428572}, 
    "Ni": {"diameter": [0.3137254901960784, 0.8156862745098039, 0.3137254901960784, 1.0], "size": 0.4821428571428572}, 
    "Cu": {"diameter": [0.7843137254901961, 0.5019607843137255, 0.2, 1.0], "size": 0.4821428571428572}, 
    "Zn": {"diameter": [0.49019607843137253, 0.5019607843137255, 0.6901960784313725, 1.0], "size": 0.4821428571428572}, 
    "Ga": {"diameter": [0.7607843137254902, 0.5607843137254902, 0.5607843137254902, 1.0], "size": 0.46428571428571436}, 
    "Ge": {"diameter": [0.4, 0.5607843137254902, 0.5607843137254902, 1.0], "size": 0.44642857142857145}, 
    "As": {"diameter": [0.7411764705882353, 0.5019607843137255, 0.8901960784313725, 1.0], "size": 0.4107142857142857}, 
    "Se": {"diameter": [1.0, 0.6313725490196078, 0.0, 1.0], "size": 0.4107142857142857}, 
    "Br": {"diameter": [0.6509803921568628, 0.1607843137254902, 0.1607843137254902, 1.0], "size": 0.4107142857142857}, 
    "Kr": {"diameter": [0.3607843137254902, 0.7215686274509804, 0.8196078431372549, 1.0], "size": 0.31428571428571433}, 
    "Rb": {"diameter": [0.4392156862745098, 0.1803921568627451, 0.6901960784313725, 1.0], "size": 0.8392857142857144}, 
    "Sr": {"diameter": [0.0, 1.0, 0.0, 1.0], "size": 0.7142857142857143}, 
    "Y": {"diameter": [0.5803921568627451, 1.0, 1.0, 1.0], "size": 0.6607142857142858}, 
    "Zr": {"diameter": [0.5803921568627451, 0.8784313725490196, 0.8784313725490196, 1.0], "size": 0.5535714285714286}, 
    "Nb": {"diameter": [0.45098039215686275, 0.7607843137254902, 0.788235294117647, 1.0], "size": 0.5178571428571429}, 
    "Mo": {"diameter": [0.32941176470588235, 0.7098039215686275, 0.7098039215686275, 1.0], "size": 0.5178571428571429}, 
    "Tc": {"diameter": [0.23137254901960785, 0.6196078431372549, 0.6196078431372549, 1.0], "size": 0.4821428571428572}, 
    "Ru": {"diameter": [0.1411764705882353, 0.5607843137254902, 0.5607843137254902, 1.0], "size": 0.46428571428571436}, 
    "Rh": {"diameter": [0.0392156862745098, 0.49019607843137253, 0.5490196078431373, 1.0], "size": 0.4821428571428572}, 
    "Pd": {"diameter": [0.0, 0.4117647058823529, 0.5215686274509804, 1.0], "size": 0.5}, 
    "Ag": {"diameter": [0.7529411764705882, 0.7529411764705882, 0.7529411764705882, 1.0], "size": 0.5714285714285715}, 
    "Cd": {"diameter": [1.0, 0.8509803921568627, 0.5607843137254902, 1.0], "size": 0.5535714285714286}, 
    "In": {"diameter": [0.6509803921568628, 0.4588235294117647, 0.45098039215686275, 1.0], "size": 0.5535714285714286}, 
    "Sn": {"diameter": [0.4, 0.5019607843137255, 0.5019607843137255, 1.0], "size": 0.5178571428571429}, 
    "Sb": {"diameter": [0.6196078431372549, 0.38823529411764707, 0.7098039215686275, 1.0], "size": 0.5178571428571429}, 
    "Te": {"diameter": [0.8313725490196079, 0.47843137254901963, 0.0, 1.0], "size": 0.5}, 
    "I": {"diameter": [0.5803921568627451, 0.0, 0.5803921568627451, 1.0], "size": 0.5}, 
    "Xe": {"diameter": [0.25882352941176473, 0.6196078431372549, 0.6901960784313725, 1.0], "size": 0.3857142857142858}, 
    "Cs": {"diameter": [0.3411764705882353, 0.09019607843137255, 0.5607843137254902, 1.0], "size": 0.9285714285714287}, 
    "Ba": {"diameter": [0.0, 0.788235294117647, 0.0, 1.0], "size": 0.7678571428571429}, 
    "La": {"diameter": [0.4392156862745098, 0.8313725490196079, 1.0, 1.0], "size": 0.6964285714285715}, 
    "Ce": {"diameter": [1.0, 1.0, 0.7803921568627451, 1.0], "size": 0.6607142857142858}, 
    "Pr": {"diameter": [0.8509803921568627, 1.0, 0.7803921568627451, 1.0], "size": 0.6607142857142858}, 
    "Nd": {"diameter": [0.7803921568627451, 1.0, 0.7803921568627451, 1.0], "size": 0.6607142857142858}, 
    "Pm": {"diameter": [0.6392156862745098, 1.0, 0.7803921568627451, 1.0], "size": 0.6607142857142858}, 
    "Sm": {"diameter": [0.5607843137254902, 1.0, 0.7803921568627451, 1.0], "size": 0.6607142857142858}, 
    "Eu": {"diameter": [0.3803921568627451, 1.0, 0.7803921568627451, 1.0], "size": 0.6607142857142858}, 
    "Gd": {"diameter": [0.27058823529411763, 1.0, 0.7803921568627451, 1.0], "size": 0.6428571428571429}, 
    "Tb": {"diameter": [0.18823529411764706, 1.0, 0.7803921568627451, 1.0], "size": 0.625}, 
    "Dy": {"diameter": [0.12156862745098039, 1.0, 0.7803921568627451, 1.0], "size": 0.625}, 
    "Ho": {"diameter": [0.0, 1.0, 0.611764705882353, 1.0], "size": 0.625}, 
    "Er": {"diameter": [0.0, 0.9019607843137255, 0.4588235294117647, 1.0], "size": 0.625}, 
    "Tm": {"diameter": [0.0, 0.8313725490196079, 0.3215686274509804, 1.0], "size": 0.625}, 
    "Yb": {"diameter": [0.0, 0.7490196078431373, 0.2196078431372549, 1.0], "size": 0.625}, 
    "Lu": {"diameter": [0.0, 0.6705882352941176, 0.1411764705882353, 1.0], "size": 0.625}, 
    "Hf": {"diameter": [0.30196078431372547, 0.7607843137254902, 1.0, 1.0], "size": 0.5535714285714286}, 
    "Ta": {"diameter": [0.30196078431372547, 0.6509803921568628, 1.0, 1.0], "size": 0.5178571428571429}, 
    "W": {"diameter": [0.12941176470588237, 0.5803921568627451, 0.8392156862745098, 1.0], "size": 0.4821428571428572}, 
    "Re": {"diameter": [0.14901960784313725, 0.49019607843137253, 0.6705882352941176, 1.0], "size": 0.4821428571428572}, 
    "Os": {"diameter": [0.14901960784313725, 0.4, 0.5882352941176471, 1.0], "size": 0.46428571428571436}, 
    "Ir": {"diameter": [0.09019607843137255, 0.32941176470588235, 0.5294117647058824, 1.0], "size": 0.4821428571428572}, 
    "Pt": {"diameter": [0.8156862745098039, 0.8156862745098039, 0.8784313725490196, 1.0], "size": 0.4821428571428572}, 
    "Au": {"diameter": [1.0, 0.8196078431372549, 0.13725490196078433, 1.0], "size": 0.4821428571428572}, 
    "Hg": {"diameter": [0.7215686274509804, 0.7215686274509804, 0.8156862745098039, 1.0], "size": 0.5357142857142857}, 
    "Tl": {"diameter": [0.6509803921568628, 0.32941176470588235, 0.30196078431372547, 1.0], "size": 0.6785714285714286}, 
    "Pb": {"diameter": [0.3411764705882353, 0.34901960784313724, 0.3803921568627451, 1.0], "size": 0.6428571428571429}, 
    "Bi": {"diameter": [0.6196078431372549, 0.30980392156862746, 0.7098039215686275, 1.0], "size": 0.5714285714285715}, 
    "Po": {"diameter": [0.6705882352941176, 0.3607843137254902, 0.0, 1.0], "size": 0.6785714285714286}, 
    "At": {"diameter": [0.4588235294117647, 0.30980392156862746, 0.27058823529411763, 1.0], "size": 0.4535714285714286}, 
    "Rn": {"diameter": [0.25882352941176473, 0.5098039215686274, 0.5882352941176471, 1.0], "size": 0.4285714285714286}, 
    "Fr": {"diameter": [0.25882352941176473, 0.0, 0.4, 1.0], "size": 0.625}, 
    "Ra": {"diameter": [0.0, 0.49019607843137253, 0.0, 1.0], "size": 0.625}, 
    "Ac": {"diameter": [0.4392156862745098, 0.6705882352941176, 0.9803921568627451, 1.0], "size": 0.6964285714285715}, 
    "Th": {"diameter": [0.0, 0.7294117647058823, 1.0, 1.0], "size": 0.6428571428571429}, 
    "Pa": {"diameter": [0.0, 0.6313725490196078, 1.0, 1.0], "size": 0.6428571428571429}, 
    "U": {"diameter": [0.0, 0.5607843137254902, 1.0, 1.0], "size": 0.625}, 
    "Np": {"diameter": [0.0, 0.5019607843137255, 1.0, 1.0], "size": 0.625}, 
    "Pu": {"diameter": [0.0, 0.4196078431372549, 1.0, 1.0], "size": 0.625}, 
    "Am": {"diameter": [0.32941176470588235, 0.3607843137254902, 0.9490196078431372, 1.0], "size": 0.625}, 
    "Cm": {"diameter": [0.47058823529411764, 0.3607843137254902, 0.8901960784313725, 1.0], "size": 0.625}, 
    "Bk": {"diameter": [0.5411764705882353, 0.30980392156862746, 0.8901960784313725, 1.0], "size": 0.625}, 
    "Cf": {"diameter": [0.6313725490196078, 0.21176470588235294, 0.8313725490196079, 1.0], "size": 0.625}, 
    "Es": {"diameter": [0.7019607843137254, 0.12156862745098039, 0.8313725490196079, 1.0], "size": 0.625}, 
    "Fm": {"diameter": [0.7019607843137254, 0.12156862745098039, 0.7294117647058823, 1.0], "size": 0.625}, 
    "Md": {"diameter": [0.7019607843137254, 0.050980392156862744, 0.6509803921568628, 1.0], "size": 0.625}, 
    "No": {"diameter": [0.7411764705882353, 0.050980392156862744, 0.5294117647058824, 1.0], "size": 0.625}, 
    "Lr": {"diameter": [0.7803921568627451, 0.0, 0.4, 1.0], "size": 0.625}, 
    "Rf": {"diameter": [0.8, 0.0, 0.34901960784313724, 1.0], "size": 0.625}, 
    "Db": {"diameter": [0.8196078431372549, 0.0, 0.30980392156862746, 1.0], "size": 0.625}, 
    "Sg": {"diameter": [0.8509803921568627, 0.0, 0.27058823529411763, 1.0], "size": 0.625}, 
    "Bh": {"diameter": [0.8784313725490196, 0.0, 0.2196078431372549, 1.0], "size": 0.625}, 
    "Hs": {"diameter": [0.9019607843137255, 0.0, 0.1803921568627451, 1.0], "size": 0.625}, 
    "Mt": {"diameter": [0.9215686274509803, 0.0, 0.14901960784313725, 1.0]}, "size": 0.625}
}


def create_basic_material(mat_name="Material", colour=default_colour):
    import bpy
    import bmesh
    import mathutils
        
    # Switch to Cycles 
    bpy.context.scene.render.engine = 'CYCLES'
    
    # check whether the material already exists
    if bpy.data.materials.get(mat_name):
        mat = bpy.data.materials[mat_name]
    else:
        # create the material
        mat = bpy.data.materials.new(mat_name)
        mat.diffuse_color = colour # viewport color RGBA
        mat.use_nodes = True
    
        # get the material nodes
        nodes = mat.node_tree.nodes
        
        # clear all nodes to start clean
        for node in nodes:
            nodes.remove(node)
        
        # create glossy node
        node_glossy = nodes.new(type='ShaderNodeBsdfGlossy')
        node_glossy.inputs[0].default_value = (1,1,1,1)  # RGBA
        node_glossy.inputs[1].default_value = 0.223 # roughness
        node_glossy.location = -200,100
        
        # create diffuse node
        node_diffuse = nodes.new(type='ShaderNodeBsdfDiffuse')
        node_diffuse.inputs[0].default_value = colour  # RGBA
        node_diffuse.inputs[1].default_value = 0.202 # roughness
        node_diffuse.location = -200,-100
        
        # create mix shader node
        node_mix = nodes.new(type='ShaderNodeMixShader')
        node_mix.inputs[0].default_value = 0.925
        node_mix.location = 0,0
        
        # create output node
        node_output = nodes.new(type='ShaderNodeOutputMaterial')   
        node_output.location = 200,0
        
        # link nodes
        links = mat.node_tree.links
        link_diff_mix = links.new(node_diffuse.outputs[0], node_mix.inputs[2])
        link_gloss_mix = links.new(node_glossy.outputs[0], node_mix.inputs[1])
        
        # link mix to output node
        link_mix_out = links.new(node_mix.outputs[0], node_output.inputs[0])
    
    return mat

def create_sphere(pos, diameter=default_diameter, atom_name="Atom", mat_name="Material", colour=default_colour):
    import bpy
    import bmesh
    import mathutils
    
    # Create an empty mesh and the object.
    mesh = bpy.data.meshes.new(atom_name)
    basic_sphere = bpy.data.objects.new(atom_name, mesh)
    
    # Add the object into the scene.
    bpy.context.collection.objects.link(basic_sphere)
    
    # Select the newly created object
    bpy.context.view_layer.objects.active = basic_sphere
    basic_sphere.select_set(True)
    
    # Construct the bmesh sphere and assign it to the blender mesh.
    bm = bmesh.new()

    # create a location matrix
    mat_loc = mathutils.Matrix.Translation(pos)
    bmesh.ops.create_uvsphere(bm, u_segments=18, v_segments=16, diameter=diameter, matrix=mat_loc)
    bm.to_mesh(mesh)
    bm.free()
    
    # smooth the surface
    bpy.ops.object.modifier_add(type='SUBSURF')
    bpy.ops.object.shade_smooth()

    # put the origin to the geometry
    bpy.ops.object.origin_set(type='ORIGIN_GEOMETRY', center='MEDIAN')

    # move the obeject to a collection
    # bpy.ops.object.move_to_collection(collection_index=0, is_new=True, new_collection_name=atom_name)
    
    ### Refine the material
    mat = create_basic_material(mat_name=mat_name, colour=colour)
    
    # Assign it to the context object
    obj = bpy.context.active_object
    
    if obj.data.materials:
        # assign to 1st material slot
        obj.data.materials[0] = mat
    else:
        # no slots
        obj.data.materials.append(mat)
    
    
def cylinder_between(point1, point2, diameter=default_diameter, mat_name="Material", colour=default_colour):
      
    import math
    import bpy
    import bmesh
    
    
    x1=point1[0]
    y1=point1[1]
    z1=point1[2]
    x2=point2[0]
    y2=point2[1]
    z2=point2[2]
    
    dx = x2 - x1
    dy = y2 - y1
    dz = z2 - z1    
    dist = math.sqrt(dx**2 + dy**2 + dz**2)
    
    bpy.ops.mesh.primitive_cylinder_add(
        vertices = 32, 
        radius = diameter,
        depth = dist,
        location = (dx/2 + x1, dy/2 + y1, dz/2 + z1)   
    ) 
    
    phi = math.atan2(dy, dx) 
    theta = math.acos(dz/dist) 
    
    bpy.context.object.rotation_euler[1] = theta 
    bpy.context.object.rotation_euler[2] = phi 
        
    # smooth the surface
    #bpy.ops.object.modifier_add(type='SUBSURF')
    bpy.ops.object.shade_smooth()

    # put the origin to the geometry
    bpy.ops.object.origin_set(type='ORIGIN_GEOMETRY', center='MEDIAN')

    ### Refine the material
    mat = create_basic_material(mat_name=mat_name, colour=colour)
    
    # Assign it to the context object
    obj = bpy.context.active_object
    
    if obj.data.materials:
        # assign to 1st material slot
        obj.data.materials[0] = mat
    else:
        # no slots
        obj.data.materials.append(mat)


def get_molecule(aseframe):
    import numpy as np
    
    mol=aseframe[np.where(np.asarray(aseframe.get_chemical_symbols())!='Au')[0]]
    # check for possible H passivating gold, far from the molecule
    # first get the z-coordinate of center of mass of the carbon backbone
    cmass_mol=int(mol[np.where(np.asarray(mol.get_chemical_symbols())=='C')[0]].get_center_of_mass()[2])
    # get hydrogens z-coordinate and cast it to an integer 
    # (to round up layers and get rid of fluctuations)
    id_hydrogens=np.where(np.asarray(mol.get_chemical_symbols())=='H')[0]
    hydrogens_z=np.asarray(list(map(int,mol[id_hydrogens].positions[:,2])))
    # discard the hydrogens far away
    id_mol=np.asarray([i for i,at in enumerate(mol) if i not in id_hydrogens[np.where(np.abs(hydrogens_z-cmass_mol)>3)[0]]])
    return mol[id_mol]

def get_substrate(aseframe):
    import numpy as np
    return aseframe[np.where(np.asarray(aseframe.get_chemical_symbols())=='Au')[0]]

def get_neighbours(aseframe):
    # get the neighbours of each atom in the molecule
    from scipy.spatial import cKDTree
    # get the kd-tree for nearest neighbors
    kdtree=cKDTree(aseframe.positions)
    neigh_list={}
    for i,pos in enumerate(aseframe.positions):
        # Query the kd-tree and get the first 7 neighbours
        _,neighs=kdtree.query(pos,k=8)
        # exclude the 1st element (the point itself)
        neigh_list[i]=neighs[1:]
    return neigh_list

def get_bonds(aseframe,cutoff=1.5):
    import numpy as np
    # get the distance matrix
    dist_mat=aseframe.get_all_distances()
    bond_list={}
    for i,dists in enumerate(dist_mat):
        bond_list[i]=[j for j in np.where(dists<1.5)[0] if i!=j]
    return bond_list

def get_bonds(aseframe,cutoff=1.5):
    import numpy as np
    # get the bonds list
    
    # get the distance matrix
    dist_mat=aseframe.get_all_distances()
    bond_list=[]
    for i,dists in enumerate(dist_mat):
        bond_list.append([np.sort([i,j]) for j in np.where(dists<1.5)[0] if i!=j])
    # returne the list of unique bonds
    return np.asarray(list(set([tuple(i) for i in np.concatenate(bond_list)])))

def split_bonds(aseframe,cutoff=1.5):
    import numpy as np
    # split the bonds with hydrogens from those without
    tot_bonds=get_bonds(aseframe,cutoff)
    # find all the bonds with hydrogens
    ll=[]
    for bond_atoms in tot_bonds:
        atom_types=[aseframe[j].symbol for j in bond_atoms]
        ll.append('H' in atom_types)
    ll=np.asarray(ll)
    id_hbonds=np.where(ll==True)[0]
    id_nohbonds=np.where(ll==False)[0]
    return tot_bonds[id_hbonds],tot_bonds[id_nohbonds]

def draw_type(aseframe,atom_type,radious):
    import numpy as np
    # draw ths spheres for a specific atom type
    for pos in aseframe[np.where(np.asarray(aseframe.get_chemical_symbols())==atom_type)[0]].positions:
        create_sphere(pos, radious*2, atom_type, atom_type)
